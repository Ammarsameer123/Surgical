<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surgical Patient Manager - Admin Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <style>
        .touch-friendly { min-height: 44px; min-width: 44px; }
        @media print { body { margin: 0; } .no-print { display: none; } }
        html { scroll-behavior: smooth; }
        button, input, select, textarea { min-height: 44px; }
        
        @media (max-width: 1024px) {
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
            .text-sm { font-size: 0.95rem; }
        }
        
        @media (max-width: 768px) {
            .grid-cols-2 { grid-template-columns: repeat(1, 1fr); }
            .text-xs { font-size: 0.8rem; }
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-overlay { backdrop-filter: blur(4px); }
        
        .form-input { transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-badge {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            animation: adminPulse 2s infinite;
            border: 2px solid #b91c1c;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
        }

        @keyframes adminPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
        }

        .danger-zone {
            background: linear-gradient(45deg, #fee2e2, #fecaca);
            border: 2px solid #f87171;
            animation: dangerGlow 3s infinite;
        }

        @keyframes dangerGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(248, 113, 113, 0.3); }
            50% { box-shadow: 0 0 15px rgba(248, 113, 113, 0.6); }
        }

        .success-pulse {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #dcfce7; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBwHk0SDN4nx5CH9wchfywS51ZFST7d1hY",
            authDomain: "surgical-patient-manager.firebaseapp.com",
            projectId: "surgical-patient-manager",
            storageBucket: "surgical-patient-manager.firebasestorage.app",
            messagingSenderId: "1038520365935",
            appId: "1:1038520365935:web:26e220d5e4edec4fcb2e9a"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.warn('The current browser does not support offline persistence');
                    }
                });
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        const { useState, useEffect } = React;

        // üîê ADMIN PROTECTION
        const checkAdminAccess = () => {
            const savedAuth = localStorage.getItem('surgical_admin_auth');
            if (savedAuth === 'Ammarsameer_authenticated') {
                return true;
            }

            const username = prompt('üë§ Username:');
            if (username === null) return false;

            const password = prompt('üîë Password:');
            if (password === null) return false;

            if (username === 'Ammarsameer' && password === 'ghaydaa1') {
                localStorage.setItem('surgical_admin_auth', 'Ammarsameer_authenticated');
                alert('‚úÖ Welcome, Supreme Admin! You have full control.');
                return true;
            } else {
                alert('‚ùå Access Denied! Invalid credentials.');
                return false;
            }
        };

        // Complete Icon Set
        const Plus = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
            </svg>
        );

        const User = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        );

        const Calendar = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        );

        const CheckCircle = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        );

        const AlertCircle = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        );

        const Edit2 = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
        );

        const Save = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
        );

        const Search = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        );

        const Crown = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3l4 6 3-6 3 6 4-6v14H5V3z"></path>
            </svg>
        );

        const X = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        );

        const Users = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
            </svg>
        );

        const Activity = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
        );

        const Settings = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        );

        const Download = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
        );
                const SurgicalPatientManager = () => {
            // Core State
            const [patients, setPatients] = useState([]);
            const [activePatient, setActivePatient] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');
            const [searchTerm, setSearchTerm] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);

            // Admin State
            const [currentUser] = useState({
                name: 'Dr. Ammar Sameer',
                role: 'admin',
                id: 'admin_001',
                username: 'Ammarsameer'
            });
            const [showAdminPanel, setShowAdminPanel] = useState(false);

            // Enhanced Role Permissions
            const rolePermissions = {
                admin: {
                    name: 'Supreme Administrator',
                    icon: 'üëë',
                    color: 'admin-badge text-white',
                    canEdit: true,
                    canPrescribe: true,
                    canDischarge: true,
                    canManageUsers: true,
                    canViewLogs: true,
                    canExportData: true,
                    canDeletePatients: true,
                    canChangePasswords: true,
                    canViewSystemStats: true,
                    canEmergencyAccess: true
                },
                attending_surgeon: {
                    name: 'Attending Surgeon',
                    icon: 'üë®‚Äç‚öïÔ∏è',
                    color: 'bg-blue-600 text-white',
                    canEdit: true,
                    canPrescribe: true,
                    canDischarge: true,
                    canManageUsers: false,
                    canViewLogs: false,
                    canExportData: false,
                    canDeletePatients: false
                },
                resident: {
                    name: 'Resident',
                    icon: 'üë©‚Äç‚öïÔ∏è',
                    color: 'bg-green-600 text-white',
                    canEdit: true,
                    canPrescribe: true,
                    canDischarge: false,
                    canManageUsers: false,
                    canViewLogs: false,
                    canExportData: false,
                    canDeletePatients: false
                },
                nurse: {
                    name: 'Nurse',
                    icon: 'üë©‚Äç‚öïÔ∏è',
                    color: 'bg-purple-600 text-white',
                    canEdit: false,
                    canPrescribe: false,
                    canDischarge: false,
                    canManageUsers: false,
                    canViewLogs: false,
                    canExportData: false,
                    canDeletePatients: false
                }
            };

            // Permission Checker
            const canPerform = (action) => {
                const permissions = rolePermissions[currentUser.role];
                return permissions?.[`can${action.charAt(0).toUpperCase()}${action.slice(1)}`] || false;
            };

            // Firebase functions
            const savePatientToFirebase = async (patient) => {
                try {
                    setSaving(true);
                    if (db) {
                        await db.collection('patients').doc(patient.id.toString()).set({
                            ...patient,
                            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                            modifiedBy: currentUser.name
                        });
                    }
                } catch (error) {
                    console.error('Error saving patient:', error);
                    alert('Error saving data. Please check your connection.');
                } finally {
                    setSaving(false);
                }
            };

            const loadPatientsFromFirebase = async () => {
                try {
                    setLoading(true);
                    if (db) {
                        const snapshot = await db.collection('patients').orderBy('lastModified', 'desc').get();
                        const loadedPatients = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                ...data,
                                id: parseInt(doc.id)
                            };
                        });
                        setPatients(loadedPatients);
                    } else {
                        loadSampleData();
                    }
                } catch (error) {
                    console.error('Error loading patients:', error);
                    loadSampleData();
                } finally {
                    setLoading(false);
                }
            };

            const loadSampleData = () => {
                const samplePatients = [
                    {
                        id: 1,
                        name: 'John Anderson',
                        age: 45,
                        mrn: 'MRN001234',
                        procedure: 'Laparoscopic Cholecystectomy',
                        surgeryDate: '2025-07-25',
                        status: 'pre-op',
                        preOpComplete: 75,
                        demographics: {
                            dob: '1979-03-15',
                            gender: 'Male',
                            phone: '(555) 123-4567',
                            address: '123 Main St, City, State 12345',
                            weight: 75,
                            height: 175,
                            allergies: ['NKDA']
                        },
                        preOpChecklist: {
                            medicalHistory: { completed: true, notes: 'HTN, controlled with medication' },
                            allergies: { completed: true, notes: 'NKDA' },
                            medications: { completed: true, notes: 'Lisinopril 10mg daily' },
                            labResults: { completed: true, notes: 'CBC, CMP, PT/PTT - all normal' },
                            imaging: { completed: false, notes: 'US abdomen pending' },
                            consent: { completed: true, notes: 'Informed consent signed' },
                            anesthesia: { completed: false, notes: 'Anesthesia consult pending' },
                            antibiotics: { completed: true, notes: 'Cefazolin 1g IV scheduled' },
                            npoStatus: { completed: true, notes: 'NPO after midnight' },
                            preOpEducation: { completed: false, notes: 'Patient education materials given' }
                        },
                        teamNotes: [
                            { 
                                user: 'Dr. Smith', 
                                userRole: 'attending_surgeon', 
                                time: '2025-07-19 09:30', 
                                note: 'Patient evaluated, cleared for surgery' 
                            }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Sarah Johnson',
                        age: 32,
                        mrn: 'MRN001235',
                        procedure: 'Appendectomy',
                        surgeryDate: '2025-07-22',
                        status: 'in-surgery',
                        preOpComplete: 100,
                        demographics: {
                            dob: '1992-11-08',
                            gender: 'Female',
                            phone: '(555) 987-6543',
                            address: '456 Oak Ave, City, State 12345',
                            weight: 68,
                            height: 165,
                            allergies: ['Penicillin']
                        },
                        preOpChecklist: {
                            medicalHistory: { completed: true, notes: 'No significant medical history' },
                            allergies: { completed: true, notes: 'Penicillin allergy documented' },
                            medications: { completed: true, notes: 'No regular medications' },
                            labResults: { completed: true, notes: 'All labs within normal limits' },
                            imaging: { completed: true, notes: 'CT scan shows acute appendicitis' },
                            consent: { completed: true, notes: 'Surgical consent obtained' },
                            anesthesia: { completed: true, notes: 'Cleared for general anesthesia' },
                            antibiotics: { completed: true, notes: 'Alternative antibiotic selected' },
                            npoStatus: { completed: true, notes: 'NPO since midnight' },
                            preOpEducation: { completed: true, notes: 'Pre-op education completed' }
                        },
                        teamNotes: [
                            { 
                                user: 'Dr. Wilson', 
                                userRole: 'attending_surgeon', 
                                time: '2025-07-22 07:15', 
                                note: 'Patient ready for surgery. Alternative antibiotic protocol due to penicillin allergy.' 
                            }
                        ]
                    }
                ];
                setPatients(samplePatients);
            };

            useEffect(() => {
                loadPatientsFromFirebase();
            }, []);

            // Patient management functions
            const addNewPatient = () => {
                const newPatient = {
                    id: Date.now(),
                    name: 'New Patient',
                    age: '',
                    mrn: '',
                    procedure: '',
                    surgeryDate: '',
                    status: 'pre-op',
                    preOpComplete: 0,
                    demographics: {
                        dob: '',
                        gender: '',
                        phone: '',
                        address: '',
                        weight: '',
                        height: '',
                        allergies: []
                    },
                    preOpChecklist: {
                        medicalHistory: { completed: false, notes: '' },
                        allergies: { completed: false, notes: '' },
                        medications: { completed: false, notes: '' },
                        labResults: { completed: false, notes: '' },
                        imaging: { completed: false, notes: '' },
                        consent: { completed: false, notes: '' },
                        anesthesia: { completed: false, notes: '' },
                        antibiotics: { completed: false, notes: '' },
                        npoStatus: { completed: false, notes: '' },
                        preOpEducation: { completed: false, notes: '' }
                    },
                    teamNotes: []
                };
                
                setPatients([newPatient, ...patients]);
                setActivePatient(newPatient);
                setIsEditing(true);
                savePatientToFirebase(newPatient);
            };

            const updatePatient = (updatedData) => {
                const updated = { ...activePatient, ...updatedData };
                setActivePatient(updated);
                
                // Update in patients array
                setPatients(patients.map(p => p.id === updated.id ? updated : p));
                
                savePatientToFirebase(updated);
            };

            const updatePreOpChecklist = (item, field, value) => {
                const updated = {
                    ...activePatient,
                    preOpChecklist: {
                        ...activePatient.preOpChecklist,
                        [item]: {
                            ...activePatient.preOpChecklist[item],
                            [field]: value
                        }
                    }
                };
                
                const total = Object.keys(updated.preOpChecklist).length;
                const completed = Object.values(updated.preOpChecklist).filter(item => item.completed).length;
                updated.preOpComplete = Math.round((completed / total) * 100);
                
                updatePatient(updated);
            };

            const addTeamNote = (note) => {
                const newNote = {
                    user: currentUser.name,
                    userRole: currentUser.role,
                    time: new Date().toLocaleString(),
                    note: note
                };
                updatePatient({
                    teamNotes: [newNote, ...activePatient.teamNotes]
                });
            };

            // Filter patients
            const filteredPatients = patients.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.mrn.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.procedure.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const getStatusColor = (status) => {
                switch (status) {
                    case 'pre-op': return 'bg-blue-100 text-blue-800';
                    case 'in-surgery': return 'bg-yellow-100 text-yellow-800';
                    case 'post-op': return 'bg-green-100 text-green-800';
                    case 'discharged': return 'bg-gray-100 text-gray-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
                        // CONNECTION STATUS COMPONENT
            const ConnectionStatus = () => {
                const [isOnline, setIsOnline] = useState(navigator.onLine);

                useEffect(() => {
                    const handleOnline = () => setIsOnline(true);
                    const handleOffline = () => setIsOnline(false);

                    window.addEventListener('online', handleOnline);
                    window.addEventListener('offline', handleOffline);

                    return () => {
                        window.removeEventListener('online', handleOnline);
                        window.removeEventListener('offline', handleOffline);
                    };
                }, []);

                return (
                    <div className={`flex items-center space-x-2 px-3 py-1 rounded-full text-xs ${
                        isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                        <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <span>{isOnline ? 'Online' : 'Offline'}</span>
                        {saving && <div className="loading-spinner"></div>}
                    </div>
                );
            };

            // PRE-OP CHECKLIST COMPONENT
            const PreOpChecklistComponent = () => {
                const items = [
                    { key: 'medicalHistory', label: 'Medical History' },
                    { key: 'allergies', label: 'Allergies' },
                    { key: 'medications', label: 'Current Medications' },
                    { key: 'labResults', label: 'Lab Results' },
                    { key: 'imaging', label: 'Imaging Studies' },
                    { key: 'consent', label: 'Informed Consent' },
                    { key: 'anesthesia', label: 'Anesthesia Clearance' },
                    { key: 'antibiotics', label: 'Prophylactic Antibiotics' },
                    { key: 'npoStatus', label: 'NPO Status' },
                    { key: 'preOpEducation', label: 'Patient Education' }
                ];

                return (
                    <div className="space-y-4">
                        {items.map(item => (
                            <div key={item.key} className="border rounded-lg p-4 bg-white shadow-sm fade-in">
                                <div className="flex items-center justify-between mb-3">
                                    <label className="flex items-center space-x-3">
                                        <input
                                            type="checkbox"
                                            checked={activePatient.preOpChecklist[item.key]?.completed || false}
                                            onChange={(e) => updatePreOpChecklist(item.key, 'completed', e.target.checked)}
                                            className="w-6 h-6 text-blue-600 rounded touch-friendly"
                                        />
                                        <span className="font-medium text-gray-900 text-lg">{item.label}</span>
                                    </label>
                                    {activePatient.preOpChecklist[item.key]?.completed && 
                                        <CheckCircle className="w-6 h-6 text-green-500" />
                                    }
                                </div>
                                
                                <textarea
                                    value={activePatient.preOpChecklist[item.key]?.notes || ''}
                                    onChange={(e) => updatePreOpChecklist(item.key, 'notes', e.target.value)}
                                    placeholder="Enter notes..."
                                    className="w-full p-3 border rounded-md text-sm form-input touch-friendly"
                                    rows="3"
                                    disabled={!canPerform('edit')}
                                />

                                {/* Special handling for specific checklist items */}
                                {item.key === 'allergies' && (
                                    <div className="mt-3 p-3 bg-yellow-50 rounded-lg">
                                        <div className="flex items-center space-x-2 mb-2">
                                            <AlertCircle className="w-4 h-4 text-yellow-600" />
                                            <span className="text-sm font-medium text-yellow-800">Patient Allergies</span>
                                        </div>
                                        <div className="text-sm text-yellow-700">
                                            {activePatient.demographics.allergies?.length > 0 
                                                ? activePatient.demographics.allergies.join(', ')
                                                : 'No known allergies documented'
                                            }
                                        </div>
                                    </div>
                                )}

                                {item.key === 'labResults' && (
                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-blue-800">Quick Lab Reference</span>
                                            <button 
                                                className="text-xs text-blue-600 hover:text-blue-800"
                                                onClick={() => alert('Lab values would be displayed here in full version')}
                                            >
                                                View Details ‚Üí
                                            </button>
                                        </div>
                                        <div className="text-xs text-blue-700">
                                            Last labs: CBC, CMP, PT/PTT - Click to view full results
                                        </div>
                                    </div>
                                )}

                                {item.key === 'antibiotics' && activePatient.demographics.weight && (
                                    <div className="mt-3 p-3 bg-green-50 rounded-lg">
                                        <div className="text-sm font-medium text-green-800 mb-2">Dosage Calculator</div>
                                        <div className="text-sm text-green-700">
                                            Patient Weight: {activePatient.demographics.weight} kg
                                        </div>
                                        <div className="text-xs text-green-600 mt-1">
                                            Recommended Cefazolin: {Math.round(activePatient.demographics.weight * 15)} mg (15 mg/kg)
                                        </div>
                                        {activePatient.demographics.allergies?.some(allergy => 
                                            allergy.toLowerCase().includes('penicillin') || 
                                            allergy.toLowerCase().includes('cephalosporin')
                                        ) && (
                                            <div className="mt-2 p-2 bg-red-100 rounded text-xs text-red-700">
                                                ‚ö†Ô∏è Alternative antibiotic needed due to documented allergies
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                );
            };

            // LOADING SCREEN
            const LoadingScreen = () => (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div className="text-center">
                        <div className="loading-spinner mx-auto mb-4" style={{width: '40px', height: '40px'}}></div>
                        <h2 className="text-xl font-semibold text-gray-900 mb-2">Loading Patient Data</h2>
                        <p className="text-gray-600">Syncing with cloud database...</p>
                    </div>
                </div>
            );

            // ADMIN PANEL COMPONENT (Simplified)
            const AdminPanel = () => (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div className="flex items-center space-x-4">
                                    <button
                                        onClick={() => setShowAdminPanel(false)}
                                        className="text-blue-600 hover:text-blue-800 flex items-center space-x-2 touch-friendly"
                                    >
                                        <span>‚Üê Back to Patients</span>
                                    </button>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900 flex items-center">
                                            <Crown className="w-6 h-6 text-red-500 mr-2" />
                                            Admin Control Panel
                                        </h1>
                                        <p className="text-sm text-gray-500">Supreme Administrator Dashboard</p>
                                    </div>
                                    <ConnectionStatus />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        {/* System Stats Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-blue-100">Total Patients</p>
                                        <p className="text-3xl font-bold">{patients.length}</p>
                                    </div>
                                    <User className="w-8 h-8 text-blue-200" />
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-green-100">Active Cases</p>
                                        <p className="text-3xl font-bold">
                                            {patients.filter(p => p.status === 'pre-op' || p.status === 'in-surgery').length}
                                        </p>
                                    </div>
                                    <Activity className="w-8 h-8 text-green-200" />
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-purple-100">Completed</p>
                                        <p className="text-3xl font-bold">
                                            {patients.filter(p => p.status === 'discharged').length}
                                        </p>
                                    </div>
                                    <CheckCircle className="w-8 h-8 text-purple-200" />
                                </div>
                            </div>
                            
                            <div className="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-yellow-100">System Status</p>
                                        <p className="text-lg font-bold">Online</p>
                                    </div>
                                    <Settings className="w-8 h-8 text-yellow-200" />
                                </div>
                            </div>
                        </div>

                        {/* Quick Actions */}
                        <div className="bg-white rounded-lg shadow-sm border p-6">
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                                <Crown className="w-5 h-5 text-red-500 mr-2" />
                                Admin Quick Actions
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <button
                                    onClick={() => alert('User management would be implemented here')}
                                    className="p-4 border border-blue-200 rounded-lg hover:bg-blue-50 text-left transition-colors"
                                >
                                    <div className="flex items-center space-x-3">
                                        <Users className="w-5 h-5 text-blue-600" />
                                        <div>
                                            <div className="font-medium text-gray-900">Manage Users</div>
                                            <div className="text-sm text-gray-500">Add, edit, or remove users</div>
                                        </div>
                                    </div>
                                </button>
                                
                                <button
                                    onClick={() => {
                                        const data = JSON.stringify({ patients, exportedAt: new Date().toISOString() }, null, 2);
                                        const blob = new Blob([data], { type: 'application/json' });
                                        const url = URL.createObjectURL(blob);
                                        const link = document.createElement('a');
                                        link.href = url;
                                        link.download = `patient-export-${new Date().toISOString().slice(0,10)}.json`;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                        URL.revokeObjectURL(url);
                                    }}
                                    className="p-4 border border-green-200 rounded-lg hover:bg-green-50 text-left transition-colors"
                                >
                                    <div className="flex items-center space-x-3">
                                        <Download className="w-5 h-5 text-green-600" />
                                        <div>
                                            <div className="font-medium text-gray-900">Export Data</div>
                                            <div className="text-sm text-gray-500">Download patient database</div>
                                        </div>
                                    </div>
                                </button>
                                
                                <button
                                    onClick={() => alert('System settings would be configured here')}
                                    className="p-4 border border-purple-200 rounded-lg hover:bg-purple-50 text-left transition-colors"
                                >
                                    <div className="flex items-center space-x-3">
                                        <Settings className="w-5 h-5 text-purple-600" />
                                        <div>
                                            <div className="font-medium text-gray-900">System Settings</div>
                                            <div className="text-sm text-gray-500">Configure application</div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* Recent Activity */}
                        <div className="bg-white rounded-lg shadow-sm border p-6 mt-6">
                            <h3 className="text-lg font-semibold mb-4">Recent Activity</h3>
                            <div className="space-y-3">
                                {patients.slice(0, 5).map((patient, index) => (
                                    <div key={index} className="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm text-gray-900">Patient {patient.name} - {patient.procedure}</p>
                                            <div className="flex items-center space-x-2 mt-1">
                                                <span className="text-xs text-gray-500">Status: {patient.status}</span>
                                                <span className="text-xs text-gray-400">‚Ä¢</span>
                                                <span className="text-xs text-gray-500">Pre-op: {patient.preOpComplete}% complete</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
                    // Loading screen
            if (loading) {
                return <LoadingScreen />;
            }

            // ADMIN PANEL VIEW
            if (showAdminPanel) {
                return <AdminPanel />;
            }

            // MAIN PATIENT LIST VIEW
            if (!activePatient) {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-white shadow-sm border-b">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex justify-between items-center py-4">
                                    <div className="flex items-center space-x-4">
                                        <h1 className="text-2xl font-bold text-gray-900">Surgical Patient Manager</h1>
                                        <ConnectionStatus />
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <button
                                            onClick={addNewPatient}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex items-center space-x-2 touch-friendly"
                                        >
                                            <Plus />
                                            <span>New Patient</span>
                                        </button>
                                        {canPerform('manageUsers') && (
                                            <button
                                                onClick={() => setShowAdminPanel(true)}
                                                className="admin-badge px-4 py-3 rounded-lg flex items-center space-x-2 touch-friendly"
                                            >
                                                <Crown />
                                                <span>Admin Panel</span>
                                            </button>
                                        )}
                                        <div className={`px-3 py-2 rounded-lg text-sm ${rolePermissions[currentUser.role].color}`}>
                                            <span>{rolePermissions[currentUser.role].icon} {currentUser.name}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            {/* Search Bar */}
                            <div className="mb-6">
                                <div className="relative">
                                    <Search className="w-5 h-5 absolute left-3 top-3 text-gray-400" />
                                    <input
                                        type="text"
                                        placeholder="Search patients by name, MRN, or procedure..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-input touch-friendly"
                                    />
                                </div>
                            </div>

                            {/* Patient Cards Grid */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredPatients.map(patient => (
                                    <div
                                        key={patient.id}
                                        onClick={() => setActivePatient(patient)}
                                        className="bg-white rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer touch-friendly fade-in"
                                    >
                                        <div className="p-6">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center space-x-3">
                                                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <User className="w-6 h-6 text-blue-600" />
                                                    </div>
                                                    <div>
                                                        <h3 className="font-semibold text-gray-900">{patient.name}</h3>
                                                        <p className="text-sm text-gray-500">MRN: {patient.mrn}</p>
                                                    </div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(patient.status)}`}>
                                                    {patient.status}
                                                </span>
                                            </div>

                                            <div className="space-y-2">
                                                <p className="text-sm text-gray-600">{patient.procedure}</p>
                                                <div className="flex items-center space-x-2 text-sm text-gray-500">
                                                    <Calendar className="w-4 h-4" />
                                                    <span>{patient.surgeryDate}</span>
                                                </div>
                                                {patient.demographics.allergies?.length > 0 && (
                                                    <div className="flex items-center space-x-2 text-sm text-red-600">
                                                        <AlertCircle className="w-4 h-4" />
                                                        <span>Allergies: {patient.demographics.allergies.join(', ')}</span>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="mt-4">
                                                <div className="flex items-center justify-between mb-1">
                                                    <span className="text-sm font-medium text-gray-700">Pre-op Complete</span>
                                                    <span className="text-sm text-gray-500">{patient.preOpComplete}%</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div
                                                        className={`h-2 rounded-full transition-all duration-300 ${
                                                            patient.preOpComplete === 100 ? 'bg-green-500' : 
                                                            patient.preOpComplete >= 75 ? 'bg-blue-500' : 
                                                            patient.preOpComplete >= 50 ? 'bg-yellow-500' : 'bg-red-500'
                                                        }`}
                                                        style={{ width: `${patient.preOpComplete}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Empty State */}
                            {filteredPatients.length === 0 && (
                                <div className="text-center py-12">
                                    <User className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                                    <h3 className="text-lg font-medium text-gray-900 mb-2">
                                        {searchTerm ? 'No patients found' : 'No patients yet'}
                                    </h3>
                                    <p className="text-gray-500 mb-4">
                                        {searchTerm 
                                            ? 'Try adjusting your search terms' 
                                            : 'Get started by adding your first patient.'
                                        }
                                    </p>
                                    {!searchTerm && (
                                        <button
                                            onClick={addNewPatient}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center space-x-2 mx-auto touch-friendly"
                                        >
                                            <Plus />
                                            <span>Add First Patient</span>
                                        </button>
                                    )}
                                </div>
                            )}

                            {/* Summary Stats */}
                            {patients.length > 0 && (
                                <div className="mt-8 bg-white rounded-lg shadow-sm border p-6">
                                    <h3 className="text-lg font-semibold mb-4">Overview</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-blue-600">{patients.length}</div>
                                            <div className="text-sm text-gray-500">Total Patients</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-yellow-600">
                                                {patients.filter(p => p.status === 'pre-op').length}
                                            </div>
                                            <div className="text-sm text-gray-500">Pre-operative</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-green-600">
                                                {patients.filter(p => p.status === 'in-surgery').length}
                                            </div>
                                            <div className="text-sm text-gray-500">In Surgery</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-gray-600">
                                                {patients.filter(p => p.status === 'discharged').length}
                                            </div>
                                            <div className="text-sm text-gray-500">Discharged</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // PATIENT DETAIL VIEW
            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div className="flex items-center space-x-4">
                                    <button
                                        onClick={() => setActivePatient(null)}
                                        className="text-blue-600 hover:text-blue-800 flex items-center space-x-2 touch-friendly"
                                    >
                                        <span>‚Üê Back to Patients</span>
                                    </button>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">{activePatient.name}</h1>
                                        <p className="text-sm text-gray-500">
                                            MRN: {activePatient.mrn} ‚Ä¢ {activePatient.procedure}
                                        </p>
                                    </div>
                                    <ConnectionStatus />
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(activePatient.status)}`}>
                                        {activePatient.status}
                                    </span>
                                    {canPerform('edit') && (
                                        <button
                                            onClick={() => setIsEditing(!isEditing)}
                                            className={`px-3 py-2 rounded-lg flex items-center space-x-2 touch-friendly transition-colors ${
                                                isEditing 
                                                    ? 'bg-green-600 hover:bg-green-700 text-white' 
                                                    : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                            }`}
                                        >
                                            {isEditing ? <Save /> : <Edit2 />}
                                            <span>{isEditing ? 'Save Changes' : 'Edit Patient'}</span>
                                        </button>
                                    )}
                                    <div className={`px-3 py-2 rounded-lg text-sm ${rolePermissions[currentUser.role].color}`}>
                                        <span>{rolePermissions[currentUser.role].icon} {currentUser.name}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        {/* Tab Navigation */}
                        <div className="mb-6">
                            <nav className="flex space-x-8 overflow-x-auto">
                                {['overview', 'pre-op', 'team'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`pb-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap touch-friendly transition-colors ${
                                            activeTab === tab
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        {tab.charAt(0).toUpperCase() + tab.slice(1).replace('-', ' ')}
                                    </button>
                                ))}
                            </nav>
                        </div>
                                                {/* Tab Content */}
                        <div className="bg-white rounded-lg shadow-sm border">
                            <div className="p-6">
                                {activeTab === 'overview' && (
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Patient Demographics */}
                                        <div>
                                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                                                <User className="w-5 h-5 mr-2 text-blue-600" />
                                                Patient Demographics
                                            </h3>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                                    <input
                                                        type="text"
                                                        value={activePatient.name}
                                                        onChange={(e) => updatePatient({ name: e.target.value })}
                                                        disabled={!isEditing}
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                                        <input
                                                            type="number"
                                                            value={activePatient.age}
                                                            onChange={(e) => updatePatient({ age: e.target.value })}
                                                            disabled={!isEditing}
                                                            className="w-full p-3 border rounded-md form-input touch-friendly"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                                                        <input
                                                            type="number"
                                                            value={activePatient.demographics.weight}
                                                            onChange={(e) => updatePatient({ 
                                                                demographics: { ...activePatient.demographics, weight: e.target.value }
                                                            })}
                                                            disabled={!isEditing}
                                                            className="w-full p-3 border rounded-md form-input touch-friendly"
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">MRN</label>
                                                    <input
                                                        type="text"
                                                        value={activePatient.mrn}
                                                        onChange={(e) => updatePatient({ mrn: e.target.value })}
                                                        disabled={!isEditing}
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Procedure</label>
                                                    <input
                                                        type="text"
                                                        value={activePatient.procedure}
                                                        onChange={(e) => updatePatient({ procedure: e.target.value })}
                                                        disabled={!isEditing}
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Surgery Date</label>
                                                    <input
                                                        type="date"
                                                        value={activePatient.surgeryDate}
                                                        onChange={(e) => updatePatient({ surgeryDate: e.target.value })}
                                                        disabled={!isEditing}
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                                    <select
                                                        value={activePatient.status}
                                                        onChange={(e) => updatePatient({ status: e.target.value })}
                                                        disabled={!isEditing || !canPerform('discharge')}
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    >
                                                        <option value="pre-op">Pre-operative</option>
                                                        <option value="in-surgery">In Surgery</option>
                                                        <option value="post-op">Post-operative</option>
                                                        <option value="discharged">Discharged</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Known Allergies</label>
                                                    <input
                                                        type="text"
                                                        value={activePatient.demographics.allergies?.join(', ') || ''}
                                                        onChange={(e) => updatePatient({ 
                                                            demographics: { 
                                                                ...activePatient.demographics, 
                                                                allergies: e.target.value.split(',').map(a => a.trim()).filter(a => a)
                                                            }
                                                        })}
                                                        disabled={!isEditing}
                                                        placeholder="Separate multiple allergies with commas"
                                                        className="w-full p-3 border rounded-md form-input touch-friendly"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Progress & Status */}
                                        <div>
                                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                                                <Activity className="w-5 h-5 mr-2 text-green-600" />
                                                Pre-op Progress
                                            </h3>
                                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-sm font-medium text-gray-700">Completion Status</span>
                                                    <span className="text-sm text-gray-500">{activePatient.preOpComplete}%</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                                    <div
                                                        className={`h-3 rounded-full transition-all duration-300 flex items-center justify-end pr-2 ${
                                                            activePatient.preOpComplete === 100 ? 'bg-green-500' : 
                                                            activePatient.preOpComplete >= 75 ? 'bg-blue-500' : 
                                                            activePatient.preOpComplete >= 50 ? 'bg-yellow-500' : 'bg-red-500'
                                                        }`}
                                                        style={{ width: `${Math.max(activePatient.preOpComplete, 10)}%` }}
                                                    >
                                                        <span className="text-xs font-medium text-white">
                                                            {activePatient.preOpComplete > 15 ? `${activePatient.preOpComplete}%` : ''}
                                                        </span>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-600">
                                                    {activePatient.preOpComplete === 100 ? 'Ready for surgery!' :
                                                     activePatient.preOpComplete >= 75 ? 'Almost ready' :
                                                     activePatient.preOpComplete >= 50 ? 'Progress ongoing' : 'Just getting started'}
                                                </p>
                                            </div>

                                            {/* Quick Info */}
                                            <div className="space-y-3">
                                                <div className="p-3 bg-blue-50 rounded-lg">
                                                    <h4 className="font-medium text-blue-900 mb-2">Quick Reference</h4>
                                                    <div className="text-sm text-blue-700 space-y-1">
                                                        <div>Age: {activePatient.age} years</div>
                                                        <div>Weight: {activePatient.demographics.weight || 'Not specified'} kg</div>
                                                        <div>Surgery: {activePatient.surgeryDate}</div>
                                                        <div>Allergies: {activePatient.demographics.allergies?.length ? 
                                                            activePatient.demographics.allergies.join(', ') : 'None documented'}</div>
                                                    </div>
                                                </div>

                                                {activePatient.demographics.allergies?.length > 0 && (
                                                    <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                        <div className="flex items-center space-x-2 mb-1">
                                                            <AlertCircle className="w-4 h-4 text-yellow-600" />
                                                            <span className="font-medium text-yellow-800">Allergy Alert</span>
                                                        </div>
                                                        <div className="text-sm text-yellow-700">
                                                            Patient has documented allergies. Ensure appropriate precautions.
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'pre-op' && <PreOpChecklistComponent />}

                                {activeTab === 'team' && (
                                    <div>
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-semibold flex items-center">
                                                <Users className="w-5 h-5 mr-2 text-blue-600" />
                                                Team Collaboration
                                            </h3>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-sm text-gray-500">
                                                    Current user: {rolePermissions[currentUser.role].name}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        {/* Add Note */}
                                        <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                                            <textarea
                                                placeholder="Add a team note..."
                                                className="w-full p-3 border rounded-md form-input touch-friendly"
                                                rows="3"
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && e.ctrlKey && e.target.value.trim()) {
                                                        addTeamNote(e.target.value);
                                                        e.target.value = '';
                                                    }
                                                }}
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Press Ctrl+Enter to add note</p>
                                        </div>

                                        {/* Team Notes */}
                                        <div className="space-y-3">
                                            {activePatient.teamNotes.length === 0 ? (
                                                <div className="text-center py-8 text-gray-500">
                                                    <Users className="w-12 h-12 text-gray-300 mx-auto mb-2" />
                                                    <p>No team notes yet. Be the first to add one!</p>
                                                </div>
                                            ) : (
                                                activePatient.teamNotes.map((note, index) => (
                                                    <div key={index} className="bg-white border rounded-lg p-4 shadow-sm">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center space-x-2">
                                                                <span className="font-medium text-gray-900">{note.user}</span>
                                                                {note.userRole && (
                                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${rolePermissions[note.userRole]?.color || 'bg-gray-100 text-gray-800'}`}>
                                                                        {rolePermissions[note.userRole]?.icon} {rolePermissions[note.userRole]?.name || note.userRole}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <span className="text-sm text-gray-500">{note.time}</span>
                                                        </div>
                                                        <p className="text-gray-700">{note.note}</p>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Check admin access and render
        const App = () => {
            const [hasAccess, setHasAccess] = useState(false);
            const [checking, setChecking] = useState(true);

            useEffect(() => {
                const access = checkAdminAccess();
                setHasAccess(access);
                setChecking(false);
            }, []);

            if (checking) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="loading-spinner mx-auto mb-4" style={{width: '40px', height: '40px'}}></div>
                            <h2 className="text-xl font-semibold text-gray-900 mb-2">Authenticating...</h2>
                            <p className="text-gray-600">Verifying credentials...</p>
                        </div>
                    </div>
                );
            }

            if (!hasAccess) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
                            <div className="text-center">
                                <div className="text-6xl mb-4">üîí</div>
                                <h1 className="text-2xl font-bold text-red-600 mb-4">Access Denied</h1>
                                <p className="text-gray-600 mb-6">You need valid credentials to access this system.</p>
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                                    >
                                        Try Again
                                    </button>
                                    <div className="text-xs text-gray-500 p-3 bg-gray-50 rounded-lg">
                                        <div className="font-medium mb-1">Demo Credentials:</div>
                                        <div>Username: Ammarsameer</div>
                                        <div>Password: ghaydaa1</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return <SurgicalPatientManager />;
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Application Error:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                            <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
                                <div className="text-center">
                                    <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                                    <h1 className="text-2xl font-bold text-red-600 mb-4">Something went wrong</h1>
                                    <p className="text-gray-600 mb-6">
                                        The application encountered an unexpected error. Please refresh the page to try again.
                                    </p>
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium"
                                    >
                                        Refresh Page
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Initialize React application
        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
    </script>
</body>
</html>
